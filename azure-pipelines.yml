trigger:
- cicd

stages:
- stage: Build
  jobs:
  - job: BuildJob
    displayName: 'Build Stage'
    pool:
      vmImage: 'windows-2019'
    steps:
    - task: Ant@1
      displayName: 'Ant build.xml'
      inputs:
        buildFile: '$(Parameters.antBuildFile)'

    - task: CopyFiles@2
      displayName: 'Copy Files to: $(build.artifactstagingdirectory)'
      inputs:
        SourceFolder: '$(system.defaultworkingdirectory)'
        TargetFolder: '$(build.artifactstagingdirectory)'
      condition: succeededOrFailed()

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: drop'
      inputs:
        PathtoPublish: '$(build.artifactstagingdirectory)'
      condition: succeededOrFailed()

- stage: Publish
  jobs:
  - job: PublishJob
    displayName: 'Publish Stage'
    pool:
      vmImage: 'windows-2019'
    steps:
    - task: UniversalPackages@0
      displayName: 'Universal publish'
      inputs:
        command: publish
        vstsFeed: 'deddc8e4-2978-46b5-bce1-12f4becb2a11/c0493aac-8cda-4ba2-ae10-46ed3a1d986f'
        vstsFeedPublish: 'deddc8e4-2978-46b5-bce1-12f4becb2a11/c0493aac-8cda-4ba2-ae10-46ed3a1d986f'
        vstsFeedPackagePublish: csv

    - task: DownloadPackage@1
      displayName: 'Download Package c3f254fa-dbfc-4892-9fab-f162749333f7'
      inputs:
        packageType: upack
        feed: 'deddc8e4-2978-46b5-bce1-12f4becb2a11/c0493aac-8cda-4ba2-ae10-46ed3a1d986f'
        view: 'a7e6578b-4e33-47a1-b596-37540a4bb1c9'
        definition: 'c3f254fa-dbfc-4892-9fab-f162749333f7'
        version: '*'

- stage: Validation
  jobs:
  - job: ValidationJob
    displayName: 'Validation Stage'
    pool:
      vmImage: 'windows-2019'
      steps:
        - script: |
              # Set Jira parameters
              $jiraUrl = "https://compliance-g.atlassian.net"
              $jiraTicketId = "PSD-103"
              $jiraApiKey = "ATATT3xFfGF0DgMTKUNYXvvHLXOVADXuftr1cs5x8CQcWL0g9C5zuyoiTiWhpP1IdX5owcmvmZmrMx9l8FAMYCFu0ypeBG3CZa-eGg0Z7Lts0wzFBQ8GpUxDQcptjYRBRTv1cK606DFVDFFXXzOZzC8Sw1XCN4ZlewTK1Sd_eBrqs5xakOfOLB8=A1956388"

              # Construct the Jira API URL to get ticket status
              $apiUrl = "$jiraUrl/rest/api/latest/issue/$jiraTicketId"

              # Make an HTTP GET request to Jira API
              $response = Invoke-RestMethod -Uri $apiUrl -Headers @{Authorization=("Basic {0}" -f [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(":$($jiraApiKey)")))} -Method Get
              # Make an HTTP GET request to Jira API
              $ticketStatus = $response.fields.status.name
              echo "name is $response.fields.status.name"



