trigger:
- cicd
parameters:
  - name: User
stages:
- stage: Build
  jobs:
  - job: BuildJob
    displayName: 'Build Stage'
    pool:
      vmImage: 'windows-2019'
    steps:
    - task: Ant@1
      displayName: 'Ant build.xml'
      inputs:
        buildFile: '$(Parameters.antBuildFile)'

    - task: CopyFiles@2
      displayName: 'Copy Files to: $(build.artifactstagingdirectory)'
      inputs:
        SourceFolder: '$(system.defaultworkingdirectory)'
        TargetFolder: '$(build.artifactstagingdirectory)'
      condition: succeededOrFailed()

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: drop'
      inputs:
        PathtoPublish: '$(build.artifactstagingdirectory)'
      condition: succeededOrFailed()

- stage: Publish
  jobs:
  - job: PublishJob
    displayName: 'Publish Stage'
    pool:
      vmImage: 'windows-2019'
    steps:
    - task: UniversalPackages@0
      displayName: 'Universal publish'
      inputs:
        command: publish
        vstsFeed: 'deddc8e4-2978-46b5-bce1-12f4becb2a11/c0493aac-8cda-4ba2-ae10-46ed3a1d986f'
        vstsFeedPublish: 'deddc8e4-2978-46b5-bce1-12f4becb2a11/c0493aac-8cda-4ba2-ae10-46ed3a1d986f'
        vstsFeedPackagePublish: csv

    - task: DownloadPackage@1
      displayName: 'Download Package c3f254fa-dbfc-4892-9fab-f162749333f7'
      inputs:
        packageType: upack
        feed: 'deddc8e4-2978-46b5-bce1-12f4becb2a11/c0493aac-8cda-4ba2-ae10-46ed3a1d986f'
        view: 'a7e6578b-4e33-47a1-b596-37540a4bb1c9'
        definition: 'c3f254fa-dbfc-4892-9fab-f162749333f7'
        version: '*'

- stage: fail
  jobs:
    - job: fail
      steps:
          - publish: '$(System.IncorrectPath)'
    - job: createTask
      displayName: Create Bug On Failure
      steps:
          - template: workitem.yml
            parameters:
            AssignedToUser: $(User)